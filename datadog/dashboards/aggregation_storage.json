{
  "title": "GTFS Aggregation & Storage",
  "description": "Monitor trajectory aggregation performance and S3 upload operations",
  "widgets": [
    {
      "id": 1,
      "definition": {
        "title": "Aggregation Success Rate",
        "title_size": "16",
        "title_align": "left",
        "type": "query_value",
        "requests": [
          {
            "formulas": [
              {
                "formula": "(query1 / (query1 + query2)) * 100"
              }
            ],
            "queries": [
              {
                "name": "query1",
                "data_source": "metrics",
                "query": "sum:gtfspb.aggregation.success{$agency,$env}.as_count()",
                "aggregator": "sum"
              },
              {
                "name": "query2",
                "data_source": "metrics",
                "query": "sum:gtfspb.aggregation.failure{$agency,$env}.as_count()",
                "aggregator": "sum"
              }
            ],
            "response_format": "scalar"
          }
        ],
        "autoscale": true,
        "precision": 1,
        "custom_unit": "%"
      },
      "layout": { "x": 0, "y": 0, "width": 3, "height": 2 }
    },
    {
      "id": 2,
      "definition": {
        "title": "S3 Upload Success Rate",
        "title_size": "16",
        "title_align": "left",
        "type": "query_value",
        "requests": [
          {
            "formulas": [
              {
                "formula": "(query1 / (query1 + query2)) * 100"
              }
            ],
            "queries": [
              {
                "name": "query1",
                "data_source": "metrics",
                "query": "sum:gtfspb.s3.upload.success{$agency,$env}.as_count()",
                "aggregator": "sum"
              },
              {
                "name": "query2",
                "data_source": "metrics",
                "query": "sum:gtfspb.s3.upload.failure{$agency,$env}.as_count()",
                "aggregator": "sum"
              }
            ],
            "response_format": "scalar"
          }
        ],
        "autoscale": true,
        "precision": 1,
        "custom_unit": "%"
      },
      "layout": { "x": 3, "y": 0, "width": 3, "height": 2 }
    },
    {
      "id": 3,
      "definition": {
        "title": "Avg Aggregation Duration",
        "title_size": "16",
        "title_align": "left",
        "type": "query_value",
        "requests": [
          {
            "queries": [
              {
                "name": "query1",
                "data_source": "metrics",
                "query": "avg:gtfspb.aggregation.duration{$agency,$env}",
                "aggregator": "avg"
              }
            ],
            "response_format": "scalar"
          }
        ],
        "autoscale": true,
        "precision": 0,
        "custom_unit": "ms"
      },
      "layout": { "x": 6, "y": 0, "width": 3, "height": 2 }
    },
    {
      "id": 4,
      "definition": {
        "title": "Avg S3 Upload Duration",
        "title_size": "16",
        "title_align": "left",
        "type": "query_value",
        "requests": [
          {
            "queries": [
              {
                "name": "query1",
                "data_source": "metrics",
                "query": "avg:gtfspb.s3.upload.duration{$agency,$env}",
                "aggregator": "avg"
              }
            ],
            "response_format": "scalar"
          }
        ],
        "autoscale": true,
        "precision": 0,
        "custom_unit": "ms"
      },
      "layout": { "x": 9, "y": 0, "width": 3, "height": 2 }
    },
    {
      "id": 5,
      "definition": {
        "title": "Aggregation Success/Failure Over Time",
        "title_size": "16",
        "title_align": "left",
        "type": "timeseries",
        "requests": [
          {
            "formulas": [
              { "formula": "query1", "alias": "Success" },
              { "formula": "query2", "alias": "Failure" }
            ],
            "queries": [
              {
                "name": "query1",
                "data_source": "metrics",
                "query": "sum:gtfspb.aggregation.success{$agency,$env}.as_count()"
              },
              {
                "name": "query2",
                "data_source": "metrics",
                "query": "sum:gtfspb.aggregation.failure{$agency,$env}.as_count()"
              }
            ],
            "response_format": "timeseries",
            "style": {
              "palette": "semantic"
            },
            "display_type": "bars"
          }
        ]
      },
      "layout": { "x": 0, "y": 2, "width": 6, "height": 3 }
    },
    {
      "id": 6,
      "definition": {
        "title": "S3 Upload Success/Failure Over Time",
        "title_size": "16",
        "title_align": "left",
        "type": "timeseries",
        "requests": [
          {
            "formulas": [
              { "formula": "query1", "alias": "Success" },
              { "formula": "query2", "alias": "Failure" }
            ],
            "queries": [
              {
                "name": "query1",
                "data_source": "metrics",
                "query": "sum:gtfspb.s3.upload.success{$agency,$env}.as_count()"
              },
              {
                "name": "query2",
                "data_source": "metrics",
                "query": "sum:gtfspb.s3.upload.failure{$agency,$env}.as_count()"
              }
            ],
            "response_format": "timeseries",
            "style": {
              "palette": "semantic"
            },
            "display_type": "bars"
          }
        ]
      },
      "layout": { "x": 6, "y": 2, "width": 6, "height": 3 }
    },
    {
      "id": 7,
      "definition": {
        "title": "Aggregation Duration (ms)",
        "title_size": "16",
        "title_align": "left",
        "type": "timeseries",
        "requests": [
          {
            "formulas": [
              { "formula": "query1", "alias": "p50" },
              { "formula": "query2", "alias": "p95" },
              { "formula": "query3", "alias": "p99" }
            ],
            "queries": [
              {
                "name": "query1",
                "data_source": "metrics",
                "query": "p50:gtfspb.aggregation.duration{$agency,$env}"
              },
              {
                "name": "query2",
                "data_source": "metrics",
                "query": "p95:gtfspb.aggregation.duration{$agency,$env}"
              },
              {
                "name": "query3",
                "data_source": "metrics",
                "query": "p99:gtfspb.aggregation.duration{$agency,$env}"
              }
            ],
            "response_format": "timeseries",
            "style": {
              "palette": "cool"
            },
            "display_type": "line"
          }
        ]
      },
      "layout": { "x": 0, "y": 5, "width": 6, "height": 3 }
    },
    {
      "id": 8,
      "definition": {
        "title": "S3 Upload Duration (ms)",
        "title_size": "16",
        "title_align": "left",
        "type": "timeseries",
        "requests": [
          {
            "formulas": [
              { "formula": "query1", "alias": "p50" },
              { "formula": "query2", "alias": "p95" },
              { "formula": "query3", "alias": "p99" }
            ],
            "queries": [
              {
                "name": "query1",
                "data_source": "metrics",
                "query": "p50:gtfspb.s3.upload.duration{$agency,$env}"
              },
              {
                "name": "query2",
                "data_source": "metrics",
                "query": "p95:gtfspb.s3.upload.duration{$agency,$env}"
              },
              {
                "name": "query3",
                "data_source": "metrics",
                "query": "p99:gtfspb.s3.upload.duration{$agency,$env}"
              }
            ],
            "response_format": "timeseries",
            "style": {
              "palette": "purple"
            },
            "display_type": "line"
          }
        ]
      },
      "layout": { "x": 6, "y": 5, "width": 6, "height": 3 }
    },
    {
      "id": 9,
      "definition": {
        "title": "Trajectories Aggregated by Route",
        "title_size": "16",
        "title_align": "left",
        "type": "timeseries",
        "requests": [
          {
            "formulas": [
              { "formula": "query1" }
            ],
            "queries": [
              {
                "name": "query1",
                "data_source": "metrics",
                "query": "sum:gtfspb.aggregation.trajectories.count{$agency,$env} by {route}"
              }
            ],
            "response_format": "timeseries",
            "style": {
              "palette": "dog_classic"
            },
            "display_type": "bars"
          }
        ]
      },
      "layout": { "x": 0, "y": 8, "width": 12, "height": 3 }
    },
    {
      "id": 10,
      "definition": {
        "title": "Files Processed per Aggregation",
        "title_size": "16",
        "title_align": "left",
        "type": "timeseries",
        "requests": [
          {
            "formulas": [
              { "formula": "query1", "alias": "Avg Files" },
              { "formula": "query2", "alias": "Max Files" }
            ],
            "queries": [
              {
                "name": "query1",
                "data_source": "metrics",
                "query": "avg:gtfspb.aggregation.files.processed{$agency,$env}"
              },
              {
                "name": "query2",
                "data_source": "metrics",
                "query": "max:gtfspb.aggregation.files.processed{$agency,$env}"
              }
            ],
            "response_format": "timeseries",
            "style": {
              "palette": "cool"
            },
            "display_type": "line"
          }
        ]
      },
      "layout": { "x": 0, "y": 11, "width": 6, "height": 3 }
    },
    {
      "id": 11,
      "definition": {
        "title": "S3 Upload Failure Types",
        "title_size": "16",
        "title_align": "left",
        "type": "toplist",
        "requests": [
          {
            "formulas": [
              { "formula": "query1", "limit": { "count": 10, "order": "desc" } }
            ],
            "queries": [
              {
                "name": "query1",
                "data_source": "metrics",
                "query": "sum:gtfspb.s3.upload.failure{$agency,$env} by {error}.as_count()",
                "aggregator": "sum"
              }
            ],
            "response_format": "scalar"
          }
        ]
      },
      "layout": { "x": 6, "y": 11, "width": 6, "height": 3 }
    },
    {
      "id": 12,
      "definition": {
        "title": "Aggregation by Agency",
        "title_size": "16",
        "title_align": "left",
        "type": "timeseries",
        "requests": [
          {
            "formulas": [
              { "formula": "query1" }
            ],
            "queries": [
              {
                "name": "query1",
                "data_source": "metrics",
                "query": "sum:gtfspb.aggregation.success{$agency,$env} by {agency}.as_count()"
              }
            ],
            "response_format": "timeseries",
            "style": {
              "palette": "dog_classic"
            },
            "display_type": "bars"
          }
        ]
      },
      "layout": { "x": 0, "y": 14, "width": 12, "height": 3 }
    }
  ],
  "template_variables": [
    {
      "name": "agency",
      "prefix": "agency",
      "available_values": [],
      "default": "*"
    },
    {
      "name": "env",
      "prefix": "env",
      "available_values": [],
      "default": "*"
    }
  ],
  "layout_type": "ordered",
  "notify_list": [],
  "reflow_type": "fixed"
}
